---
name: T2-Microservices (Minimal Scenario with JMeter - debugging)
author: David Kopp
description: Logging is enabled for all relevant containers

compose-file: !include microservices-compose.yml

services:
  postgres:
    log-stdout: true
    log-stderr: true
    setup-commands:
       - sleep 5
  mongo:
    log-stdout: true
    log-stderr: true
  cdcservice:
    log-stdout: true
    log-stderr: true
    setup-commands:
      - sleep 10
  inventory:
    log-stdout: true
    log-stderr: true
    environment:
      LOGGING_LEVEL_DE_UNISTUTTGART_T2: DEBUG
  cart:
    log-stdout: true
    log-stderr: true
    environment:
      LOGGING_LEVEL_DE_UNISTUTTGART_T2: DEBUG
  order:
    log-stdout: true
    log-stderr: true
    environment:
      LOGGING_LEVEL_DE_UNISTUTTGART_T2: DEBUG
  orchestrator:
    log-stdout: true
    log-stderr: true
    read-notes-stdout: true
    environment:
      LOGGING_LEVEL_DE_UNISTUTTGART_T2: DEBUG
      T2_GMT_LOGGING_ENABLED: true # SCI note get logged by orchestrator after Saga completed
  payment:
    log-stdout: true
    log-stderr: true
    environment:
      LOGGING_LEVEL_DE_UNISTUTTGART_T2: DEBUG
  uibackend:
    log-stdout: true
    log-stderr: true
    environment:
      LOGGING_LEVEL_DE_UNISTUTTGART_T2: DEBUG
    setup-commands:
       - sleep 30
  jmeter:
    log-stdout: true
    log-stderr: true

flow:
  - name: Running JMeter
    container: jmeter
    commands:
      - type: console
        command: jmeter -Jhostname=uibackend -Jport=8080 -JnumExecutions=1 -JnumUser=1 -JrampUp=0 -JnumProducts=1 -JthinkTimeMin=1000 -JthinkTimeAdditionalRange=0 -JpauseBeforeExecution=1000 -JpauseAfterExecution=2000 -JloggingEnabled=true -n -t /tmp/repo/t2-project-flexible.jmx -l results.csv
        log-stdout: true
        log-stderr: true
        read-notes-stdout: true
        read-sci-stdout: false
  - name: Print JMeter Results
    container: jmeter
    commands:
      - type: console
        command: cat results.csv
        log-stdout: true
        log-stderr: true
